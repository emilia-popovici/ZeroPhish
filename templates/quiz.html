<!DOCTYPE html>
<html lang="ro">
<head>
    <title>{{ t['quiz_page_title'] }} {{ lectie.titlu }}</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='icons/favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='icons/favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/apple-touch-icon.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='icons/site.webmanifest') }}">
    <meta name="apple-mobile-web-app-title" content="ZeroPhish">
    <meta name="application-name" content="ZeroPhish">
    <meta name="msapplication-TileColor" content="#7E8C69"> <meta name="theme-color" content="#ECE0DA">
</head>
<body>

    <button class="profil-corner" type="button" data-bs-toggle="offcanvas" data-bs-target="#sideMenu">
        <div class="profil-badge">
            {% if current_user.avatar %}
                <img src="{{ url_for('static', filename='uploads/' + current_user.avatar) }}">
            {% else %}
                {{ current_user.username[0] | upper }}
            {% endif %}
        </div>
    </button>

    <div class="offcanvas offcanvas-end" tabindex="-1" id="sideMenu">
        <div class="offcanvas-header d-flex align-items-center">
            <div class="avatar-large">
                {% if current_user.avatar %}
                    <img src="{{ url_for('static', filename='uploads/' + current_user.avatar) }}">
                {% else %}
                    {{ current_user.username[0] | upper }}
                {% endif %}
            </div>
            <div class="user-info"><h3>@{{ current_user.username }}</h3></div>
            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div class="sidebar-nav mt-3">
                <a href="/" class="nav-link-custom">{{ t['nav_dashboard'] }}</a>
                <a href="/profil" class="nav-link-custom">{{ t['nav_scores'] }}</a>
                
                <a href="#langSubmenu" data-bs-toggle="collapse" class="nav-link-custom collapsed">
                    {{ t['nav_lang'] }} <span class="arrow-icon">‚ñº</span>
                </a>
                <ul class="collapse sub-menu" id="langSubmenu">
                    <li><a href="/set_lang/ro">Rom√¢nƒÉ</a></li>
                    <li><a href="/set_lang/en">English</a></li>
                    <li><a href="/set_lang/ru">–†—É—Å—Å–∫–∏–π</a></li>
                    <li><a href="/set_lang/fr">Fran√ßais</a></li>
                </ul>

                <a href="/settings" class="nav-link-custom">{{ t['nav_settings'] }}</a>
                <hr style="border-color: rgba(255,255,255,0.3); margin: 20px 0;">
                <a href="/logout" class="nav-link-custom" style="color: #ffcccc;">{{ t['nav_logout'] }}</a>
            </div>
        </div>
    </div>
    <div class="quiz-container" id="quiz-box">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="text-muted m-0" style="color: var(--dark-green) !important;">{{ lectie.titlu }}</h5>
            <span class="badge bg-primary rounded-pill px-3 py-2" style="background-color: var(--dark-green) !important;">
                {{ t['lbl_question_no'] }} <span id="q-number">1</span> / {{ lectie.quiz_questions|length }}
            </span>
        </div>
        <hr style="opacity: 0.1">

        <div id="question-area">
            <h3 id="question-text" class="mb-3 fw-bold">...</h3>
            <p class="text-muted small mb-4 fst-italic" id="instruction-text" style="color: var(--soft-green) !important;">
                {{ t['lbl_select_correct'] }}
            </p>
            <div id="options-area"></div>
        </div>

        <div class="mt-5 d-flex justify-content-end">
            <button class="btn" id="btn-next" onclick="nextQuestion()">{{ t['btn_next_q'] }} &rarr;</button>
            <button class="btn" id="btn-finish" onclick="finishQuiz()" style="display: none;">{{ t['btn_finish_quiz'] }} üèÜ</button>
        </div>
    </div>

    <div class="quiz-container" id="results-box" style="display: none;">
        <div class="text-center mb-5">
            <h1 class="display-3 fw-bold" id="final-score-text" style="color: var(--dark-green);">0/0</h1>
            <p class="lead" id="final-message">{{ t['msg_bravo'] }}</p>
            <div class="progress" style="height: 25px;">
                <div class="progress-bar" id="score-bar" role="progressbar" style="width: 0%"></div>
            </div>
        </div>
        <h3 class="mb-4" style="color: var(--dark-green);">üîç {{ t['lbl_report'] }}</h3>
        <div id="review-list"></div>
        <div class="text-center mt-5">
            <a href="/lectie/{{ id_curent }}" class="btn-back px-4 py-2" style="margin-top: 0; margin-right: 15px;">{{ t['btn_restart'] }}</a>
            <a href="/" class="btn-success ms-3 px-4 py-2" style="text-decoration: none;">{{ t['btn_main_menu'] }}</a>
        </div>
    </div>

    <form id="score-form" method="POST" action="/quiz/{{ id_curent }}" style="display: none;">
        <input type="hidden" name="score_data" id="score_data_input">
    </form>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const quizData = {{ lectie.quiz_questions | tojson }};
        const lessonId = {{ id_curent }};
        const storageKey = `quiz_progress_${lessonId}`;

        let currentStep = 0;
        let userAnswers = new Array(quizData.length).fill().map(() => []); 

        const TEXTS = {
            multi: "{{ t['js_multi_choice'] }}",
            single: "{{ t['js_single_choice'] }}",
            alert: "{{ t['js_alert_select'] }}",
            yours: "{{ t['js_you_chose'] }}",
            correct_was: "{{ t['js_correct_was'] }}",
            correct_msg: "{{ t['js_correct_msg'] }}"
        };

        function saveProgress() {
            const progress = {
                step: currentStep,
                answers: userAnswers
            };
            localStorage.setItem(storageKey, JSON.stringify(progress));
        }

        function loadProgress() {
            const saved = localStorage.getItem(storageKey);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.answers && data.answers.length === quizData.length) {
                        currentStep = data.step || 0;
                        userAnswers = data.answers;
                    }
                } catch (e) {
                    console.error("Eroare la √ÆncƒÉrcarea progresului", e);
                }
            }
        }

        function clearProgress() {
            localStorage.removeItem(storageKey);
        }
        
        function loadQuestion(index) {
            document.getElementById('q-number').innerText = index + 1;
            document.getElementById('question-text').innerHTML = quizData[index].intrebare;
            
            const isMulti = quizData[index].corect.length > 1;
            document.getElementById('instruction-text').innerText = isMulti ? TEXTS.multi : TEXTS.single;

            const optionsDiv = document.getElementById('options-area');
            optionsDiv.innerHTML = '';

            quizData[index].variante.forEach(varianta => {
                const btn = document.createElement('button');
                btn.className = 'option-btn';
                btn.innerText = varianta;
                if (userAnswers[index].includes(varianta)) {
                    btn.classList.add('selected');
                }

                btn.onclick = () => toggleOption(varianta, btn, index);
                optionsDiv.appendChild(btn);
            });

            updateNavButtons();
        }

        function toggleOption(raspuns, btn, index) {
            let currentSelections = userAnswers[index];
            const isMulti = quizData[index].corect.length > 1;

            if (isMulti) {
                if (currentSelections.includes(raspuns)) {
                    currentSelections = currentSelections.filter(item => item !== raspuns);
                    btn.classList.remove('selected');
                } else {
                    currentSelections.push(raspuns);
                    btn.classList.add('selected');
                }
            } else {
                const allBtns = document.querySelectorAll('.option-btn');
                allBtns.forEach(b => b.classList.remove('selected'));
                currentSelections = [raspuns];
                btn.classList.add('selected');
            }
            userAnswers[index] = currentSelections;
            saveProgress();
        }

        function updateNavButtons() {
            const nextBtn = document.getElementById('btn-next');
            const finishBtn = document.getElementById('btn-finish');

            if (currentStep === quizData.length - 1) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'block';
                finishBtn.style.display = 'none';
            }
        }

        function nextQuestion() {
            if (userAnswers[currentStep].length === 0) {
                alert(TEXTS.alert);
                return;
            }
            if (currentStep < quizData.length - 1) {
                currentStep++;
                saveProgress();
                loadQuestion(currentStep);
            }
        }

        function finishQuiz() {
            if (userAnswers[currentStep].length === 0) {
                alert(TEXTS.alert);
                return;
            }
            clearProgress();

            let score = 0;
            const reviewList = document.getElementById('review-list');
            reviewList.innerHTML = '';

            let postData = {};

            quizData.forEach((q, index) => {
                const userChoiceSorted = [...userAnswers[index]].sort();
                const correctSorted = [...q.corect].sort();
                
                const isCorrect = JSON.stringify(userChoiceSorted) === JSON.stringify(correctSorted);
                
                if (isCorrect) score++;

                userAnswers[index].forEach(ans => {
                    if(!postData[`question_${q.id}`]) postData[`question_${q.id}`] = [];
                    postData[`question_${q.id}`].push(ans);
                });

                const card = document.createElement('div');
                card.className = isCorrect ? 'review-card correct' : 'review-card wrong';
                
                let html = `<div class="fw-bold mb-2 fs-5">${index + 1}. ${q.intrebare}</div>`;
                html += `<div class="mb-1"><span class="badge bg-secondary">${TEXTS.yours}</span> ${userAnswers[index].join(', ')}</div>`;
                
                if (!isCorrect) {
                    html += `<div class="mb-2"><span class="badge bg-success">${TEXTS.correct_was}</span> ${q.corect.join(', ')}</div>`;
                } else {
                    html += `<div class="mb-2 text-success fw-bold">‚úÖ ${TEXTS.correct_msg}</div>`;
                }

                html += `<div class="explanation">üí° ${q.explicatie}</div>`;
                card.innerHTML = html;
                reviewList.appendChild(card);
            });

            document.getElementById('quiz-box').style.display = 'none';
            document.getElementById('results-box').style.display = 'block';
            
            const percentage = Math.round((score / quizData.length) * 100);
            document.getElementById('final-score-text').innerText = `${score} / ${quizData.length}`;
            document.getElementById('score-bar').style.width = `${percentage}%`;
            
            if (percentage === 100) document.getElementById('score-bar').className = "progress-bar bg-success";
            else if (percentage >= 50) document.getElementById('score-bar').className = "progress-bar bg-warning";
            else document.getElementById('score-bar').className = "progress-bar bg-danger";

            submitScoreToServer(postData);
        }

        function submitScoreToServer(data) {
            const formData = new FormData();
            for (const key in data) {
                data[key].forEach(val => {
                    formData.append(key, val);
                });
            }
            fetch(window.location.href, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) console.log("Salvat");
            }).catch(error => console.error("Eroare", error));
        }
        loadProgress();
        loadQuestion(currentStep);
    </script>
</body>
</html>