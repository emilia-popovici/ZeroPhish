<!DOCTYPE html>
<html lang="{{ lang_curenta }}">
<head>
    <meta charset="UTF-8">
    <title>{{ t['auth_login'] if mode == 'login' else t['auth_register'] }} - ZeroPhish</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='icons/favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='icons/favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/apple-touch-icon.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='icons/site.webmanifest') }}">
    <meta name="apple-mobile-web-app-title" content="ZeroPhish">
    <meta name="application-name" content="ZeroPhish">
    <meta name="msapplication-TileColor" content="#7E8C69"> <meta name="theme-color" content="#ECE0DA">
</head>
<body>
    <div class="auth-card">
        <h2 class="text-center mb-4 brand-title">ZeroPhish</h2>
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" id="authForm" action="{{ url_for('login') if mode == 'login' else url_for('register') }}">
            <h4 class="mb-4 text-center">
                {{ t['auth_login'] if mode == 'login' else t['auth_register'] }}
            </h4>
            
            {% if mode == 'register' %}
                <div class="row mb-3">
                    <div class="col">
                        <label>{{ t['lbl_firstname'] }} *</label>
                        <input type="text" name="first_name" class="form-control validate-name" required>
                        <div class="error-msg">{{ t['err_name_invalid'] }}</div>
                    </div>
                    <div class="col">
                        <label>{{ t['lbl_lastname'] }} *</label>
                        <input type="text" name="last_name" class="form-control validate-name" required>
                        <div class="error-msg">{{ t['err_name_invalid'] }}</div>
                    </div>
                </div>

                <div class="mb-3">
                    <label>{{ t['lbl_email'] }} *</label>
                    <input type="email" name="email" class="form-control validate-email" required>
                    <div class="error-msg">{{ t['err_email_invalid'] }}</div>
                </div>

                <div class="mb-3">
                    <label>{{ t['lbl_phone'] }}</label>
                    <div class="phone-group">
                        <div class="prefix-wrapper">
                            <span class="prefix-display" id="prefixDisplay">+40</span>
                            <span class="prefix-arrow">▼</span>
                            <select name="phone_prefix" class="prefix-select" onchange="updatePrefix(this)">
                                {% for tara in lista_tari %}
                                    <option value="{{ tara.code }}" {% if tara.code == '+40' %}selected{% endif %}>
                                        {{ tara.name }} ({{ tara.code }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <input type="text" name="phone_number" class="form-control validate-phone" placeholder="xxx xxx xxx">
                    </div>
                    <div class="error-msg">{{ t['err_phone_invalid'] }}</div>
                </div>

                <div class="mb-3">
                    <label>{{ t['lbl_desired_user'] }} *</label>
                    <input type="text" name="username" class="form-control validate-username" required>
                    <div class="error-msg">{{ t['err_username_short'] }}</div>
                </div>

            {% else %}
                <div class="mb-3">
                    <label>{{ t['lbl_login_input'] }}</label>
                    <input type="text" name="login_id" class="form-control" required>
                </div>
            {% endif %}
            
            <div class="mb-4">
                <label>{{ t['lbl_pass'] }} *</label>
                <input type="password" name="password" class="form-control {{ 'validate-password' if mode == 'register' else 'validate-required' }}" required>
                {% if mode == 'register' %}
                    <div class="error-msg">{{ t['err_password_complex'] }}</div>
                {% endif %}
            </div>

            <button type="submit" id="submitBtn" class="btn btn-primary w-100 py-3 {{ 'btn-disabled' if mode == 'register' else '' }}">
                {{ t['btn_enter'] if mode == 'login' else t['btn_create'] }}
            </button>

            {% if mode == 'register' %}
                <div class="mandatory-note">
                    {{ t['msg_mandatory_fields'] }}
                </div>
            {% endif %}
        </form>

        <div class="text-center mt-4 pt-3 border-top">
            {% if mode == 'login' %}
                <a href="/register">{{ t['link_no_acc'] }}</a>
            {% else %}
                <a href="/login">{{ t['link_has_acc'] }}</a>
            {% endif %}
        </div>

        <div class="lang-container">
            <button type="button" class="btn-lang-trigger" onclick="toggleAuthLang()">
                {{ t['nav_lang'] }} <small>▼</small>
            </button>
            <ul class="lang-dropdown" id="authLangMenu">
                <li><a href="/set_lang/ro">Română</a></li>
                <li><a href="/set_lang/en">English</a></li>
                <li><a href="/set_lang/ru">Русский</a></li>
                <li><a href="/set_lang/fr">Français</a></li>
            </ul>
        </div>
    </div>

    <script>
        function toggleAuthLang() {
            const menu = document.getElementById('authLangMenu');
            menu.classList.toggle('show');
        }

        window.onclick = function(event) {
            if (!event.target.closest('.lang-container')) {
                const menu = document.getElementById('authLangMenu');
                if (menu) menu.classList.remove('show');
            }
        }

        function updatePrefix(selectElement) {
            const wrapper = selectElement.closest('.prefix-wrapper');
            const display = wrapper.querySelector('.prefix-display');
            if(display) display.textContent = selectElement.value;
        }

        {% if mode == 'register' %}
        document.addEventListener('DOMContentLoaded', function() {
            
            const patterns = {
                name: /^[a-zA-ZăâîșțĂÂÎȘȚ\s\-]+$/,
                email: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                phone: /^[\d\s]+$/,
                username: /^.{3,}$/, 
                password: /^(?=.*[0-9])(?=.*[!@#$%^&*])[a-zA-Z0-9!@#$%^&*]{8,}$/
            };

            const form = document.getElementById('authForm');
            const submitBtn = document.getElementById('submitBtn');
            const inputs = form.querySelectorAll('input');

            const prefixSelect = document.querySelector('.prefix-select');
            if (prefixSelect) updatePrefix(prefixSelect);

            function checkFormValidity() {
                let allValid = true;

                inputs.forEach(input => {
                    const value = input.value.trim();
                    let fieldValid = true;

                    if (input.classList.contains('validate-name')) {
                        fieldValid = patterns.name.test(value) && value.length > 1;
                    } 
                    else if (input.classList.contains('validate-email') && value.length > 0) {
                        fieldValid = patterns.email.test(value);
                    } 
                    else if (input.classList.contains('validate-phone') && value.length > 0) {
                        const cleanPhone = value.replace(/\s/g, '');
                        fieldValid = patterns.phone.test(value) && cleanPhone.length > 5;
                    } 
                    else if (input.classList.contains('validate-username')) {
                        fieldValid = patterns.username.test(value);
                    }
                    else if (input.classList.contains('validate-password')) {
                        fieldValid = patterns.password.test(value);
                    }
                    else if (input.classList.contains('validate-required')) {
                        fieldValid = value.length > 0;
                    }

                    const errorMsg = input.closest('.mb-3, .mb-4, .col')?.querySelector('.error-msg');
                    
                    if (!fieldValid && value.length > 0) {
                        input.classList.add('is-invalid');
                        if (errorMsg) errorMsg.style.display = 'block';
                        allValid = false;
                    } 
                    else {
                        input.classList.remove('is-invalid');
                        if (errorMsg) errorMsg.style.display = 'none';
                    }
                    
                    if (input.hasAttribute('required') && value.length === 0) {
                        allValid = false;
                    }
                });

                if (allValid) {
                    submitBtn.classList.remove('btn-disabled');
                    submitBtn.disabled = false;
                } 
                else {
                    submitBtn.classList.add('btn-disabled');
                }
            }

            inputs.forEach(input => {
                input.addEventListener('input', checkFormValidity);
            });
        });
        {% endif %}
    </script>
</body>
</html>